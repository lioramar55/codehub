@let e = event(); @if (e.type === 'system') {
<div
  class="text-center text-xs text-slate-500 dark:text-slate-400"
  role="status"
  aria-live="polite"
  aria-atomic="true"
>
  @if (e.kind === 'join') { {{ e.user?.name }} joined the chat } @if (e.kind ===
  'leave') { {{ e.user?.name }} left the chat }
</div>
} @else { @let isSelf = !e.user?.isBot && e.user?.id === currentUserId();

<div class="flex items-end gap-3" [class.flex-row-reverse]="isSelf">
  <!--  Avatar -->
  <img
    [ngSrc]="e.user?.avatarUrl || defaultAvatar(e.user?.name || '')"
    width="40"
    height="40"
    class="h-10 w-10 rounded-full"
    [attr.alt]="(e.user?.name || 'User') + ' avatar'"
  />

  <!-- Message bubble with timestamp inside -->
  <div class="max-w-[60%] min-w-0 relative">
    <div
      class="flex flex-col rounded-2xl px-4 py-2 text-sm shadow-sm whitespace-pre-wrap break-words w-full"
      [ngClass]="{
        'bg-white dark:bg-slate-700': !isSelf && !e.user?.isBot,
        'bg-primary-user text-white': isSelf,
        'bg-primary-bot text-slate-900 dark:bg-slate-800 dark:text-slate-100':
          e.user?.isBot
      }"
    >
      @if (!isSelf && e.user) {
      <!-- Author name -->
      <div
        class="text-xs text-slate-500 dark:text-slate-300 font-bold cursor-default"
      >
        {{ e.user.name }}
      </div>
      }
      <div class="ps-2" [appAutoRtl]="e.content">
        {{ e.content }}
      </div>

      <!-- Enhanced Bot indicator badge -->
      @if (e.isSentToBot && !e.user?.isBot) {
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-1.5 sm:gap-2">
          <!-- AI Assistant Badge -->
          <div class="group relative">
            <div
              class="flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 rounded-full text-xs font-medium bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-200/50 dark:border-blue-500/30 text-blue-700 dark:text-blue-300 glass-effect transition-all duration-300 hover:scale-105 badge-pulse"
            >
              <!-- Animated AI Icon -->
              <div class="relative">
                <svg
                  class="w-3 h-3 sm:w-3.5 sm:h-3.5 transition-all duration-300 group-hover:animate-pulse"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.9 1 3 1.9 3 3V21C3 22.1 3.9 23 5 23H19C20.1 23 21 22.1 21 21V9ZM19 9H14V4H5V21H19V9ZM16 12C16 10.9 15.1 10 14 10H10C8.9 10 8 10.9 8 12V16C8 17.1 8.9 18 10 18H14C15.1 18 16 17.1 16 16V12ZM14 16H10V12H14V16Z"
                  />
                </svg>
                <!-- Status Dot -->
                <div
                  class="absolute -top-0.5 -right-0.5 w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-400 rounded-full status-dot-pulse"
                ></div>
              </div>
              <span class="font-semibold text-xs sm:text-xs">AI</span>
            </div>

            <!-- Tooltip - Hidden on mobile to avoid touch issues -->
            <div
              class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-900 dark:bg-slate-800 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 hidden sm:block"
            >
              This message will trigger AI response
              <div
                class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900 dark:border-t-slate-800"
              ></div>
            </div>
          </div>
        </div>
      </div>
      }

      <time
        class="mt-1 text-[10px] opacity-70"
        [class.self-start]="isSelf"
        [class.self-end]="!isSelf"
        [attr.datetime]="e.createdAt | date : 'yyyy-MM-ddTHH:mm:ss'"
      >
        {{ e.createdAt | date : 'shortTime' }}
      </time>
    </div>
  </div>
</div>
}
